<!doctype html>
<html>
    <head>
        <meta name="viewport" content="width=device-width" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>CovidWawa</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/css/bootstrap.min.css" integrity="sha384-DhY6onE6f3zzKbjUPRc2hOzGAdEf4/Dz+WJwBvEYL/lkkIsI3ihufq9hk9K4lVoK" crossorigin="anonymous">
        <style>
            #table {
                width: auto;
            }
            
            #table tbody tr td:nth-child(2n) {
                border-left: 1px solid;
                border-left-color: inherit;
            }
        </style>
    </head>
    <body>
        <div id="chart"></div>
        <div class="container">
            <table id="table" class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">Dzień</th>
                        <th scope="col">Zakażonych</th>
                        <th scope="col"><span class="text-muted">nowych</span></th>
                        <th scope="col">Zgonów</th>
                        <th scope="col"><span class="text-muted">nowych</span></th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_data|reverse %}
                        <tr>
                            <th scope="row" class="day" data-timestamp="{{ (row.day.timestamp() * 1000) | int }}">
                                {{ row.day.strftime('%d.%m.%Y') }}
                            </th>
                            <td>{{ row.positive }}</td>
                            <td>{{ '%+d' % row.daily.positive }}</td>
                            <td>{{ row.deaths }}</td>
                            <td>{{ '%+d' % row.daily.deaths }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="text/javascript">
            var data = {{chart_data}}, viewport_x = {{viewport_x}}, viewport_y = {{viewport_y}};
            google.charts.load('current', {'packages': ['corechart'], 'language': 'pl'});

            function draw() {
                var dataTable = new google.visualization.DataTable();
                dataTable.addColumn('date', 'Dzień');
                dataTable.addColumn('number', 'Zakażenia');
                dataTable.addColumn('number', 'Zgony');
                
                dataTable.addRows(data);
                
                var options = {
                    title: 'Warszawa: nowe zakażenia (średnia krocząca z 7 dni) oraz nowe zgony',
                    width: '100%',
                    height: 800,
                    curveType: 'function',
                    theme: 'material',
                    explorer: {
                        axis: 'horizontal',
                        actions: ['dragToPan']
                    },
                    series: {
                        0: { color: 'red' },
                        1: { color: 'black', lineWidth: 1 }
                    },
                    hAxis: { viewWindow: { min: viewport_x } },
                    vAxis: { minValue: 0, viewWindow: { min: 0, max: viewport_y } },
                    annotations: {
                        textStyle: {
                            fontSize: 18,
                            bold: true,
                            color: '#000',
                            opacity: 1
                        }
                    }
                };

                var chart = new google.visualization.LineChart(document.getElementById('chart'));
                chart.draw(dataTable, options);

                window.addEventListener('resize', debounce(function(){
                    var chart = new google.visualization.LineChart(document.getElementById('chart'));
                    chart.draw(dataTable, options);
                }));
            }

            var debounce = function (func, threshold, execAsap) {
                var timeout;

                return function debounced () {
                    var obj = this, args = arguments;

                    function delayed () {
                        if (!execAsap)
                            func.apply(obj, args);
                        timeout = null;
                    }

                    if (timeout)
                        clearTimeout(timeout);
                    else if (execAsap)
                        func.apply(obj, args);

                    timeout = setTimeout(delayed, threshold || 100);
                };
            }

            google.charts.setOnLoadCallback(draw);
            
            for (let element of document.querySelectorAll('.day')) {
                let date = new Date(parseInt(element.dataset.timestamp));
                
                if (date.toDateString() === new Date().toDateString()) {
                    element.innerText = 'dzisiaj';
                }
                
                let yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (date.toDateString() === yesterday.toDateString()) {
                    element.innerText = 'wczoraj';
                }
            }
         </script>
    </body>
</html>